<!DOCTYPE HTML>
<html lang="en">


<!-- Mirrored from wp.alithemes.com/html/evara/evara-backend/page-orders-detail.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 01 Aug 2021 15:33:22 GMT -->

<head>
    <meta charset="utf-8">
    <title>transform-toys.store</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="">
    <meta property="og:type" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="/public/assets/imgs/theme/favicon.jpg">
    <!-- Template CSS -->
    <link href="/admin-assets/css/main.css" rel="stylesheet" type="text/css" />
</head>
<style>
    .dark-text {
    color: #333; 
    font-weight: bold;
}
</style>

<body>
    <div class="screen-overlay"></div>
    <aside class="navbar-aside" id="offcanvas_aside">
        <div class="aside-top">
            <a href="index.html" class="brand-wrap">
                <img src="/assets/imgs/theme/logo.jpg" class="logo" alt="Evara Dashboard">
            </a>
            <div>
                <button class="btn btn-icon btn-aside-minimize"> <i class="text-muted material-icons md-menu_open"></i>
                </button>
            </div>
        </div>
        <nav>

            </ul>
            <br>
            <br>
        </nav>
    </aside>
    <main class="main-wrap">
        <header class="main-header navbar">
            <div class="col-search">
                <!-- <form class="searchform"> -->

            </div>
            </li>
            </ul>
            </div>
        </header>
        <section class="content-main">
            <div class="content-header">
                <div>
                    <h2 class="content-title card-title">Order Detail</h2>
                    <p >Details for Order ID: <small id="orderId"><%=order.orderid%></small>
                    </p>
                </div>
            </div>
            <div class="card">
                <header class="card-header">
                    <div class="row align-items-center">
                        <div class="col-lg-6 col-md-6 mb-lg-0 mb-15">
                            <span>
                                <i class="material-icons md-calendar_today"></i> <b>
                                    <%=order.createdAt.toDateString()%>
                                </b>
                            </span> <br>
                            <small class="text-muted">Order ID: <%=order.orderid%></small>
                        </div>
                        <div class="col-lg-6 col-md-6 ms-auto text-md-end">

                            </select>
                            <% if(order.status==='Delivered' ){ %>    
                                <input type="hidden" value="<%= JSON.stringify(order) %>" id="orderData">
                                <button class="btn btn-info" id="InvoiceButton" onclick="invoiceDownload()">Download
                                    Invoice</button>
                                <% } %>
                        </div>
                    </div>
                </header> <!-- card-header end// -->
                <div class="card-body">
                    <div class="row mb-50 mt-20 order-info-wrap">
                        <div class="col-md-4">
                            <article class="icontext align-items-start">
                                <span class="icon icon-sm rounded-circle bg-primary-light">
                                    <i class="text-primary material-icons md-person"></i>
                                </span>
                                <div class="text">
                                    <h6 class="mb-1">Customer</h6>
                                    <p class="mb-1">
                                        <%=order.userId.name%><br> <template class="__cf_email__"
                                                data-cfemail="e2838e879aa2879a838f928e87cc818d8f">[email&#160;protected]</template>
                                            <br>
                                            <%=order.userId.mobile%>
                                    </p>
                                    <a href="#">View profile</a>
                                </div>
                            </article>
                        </div> <!-- col// -->
                        <div class="col-md-4">
                            <article class="icontext align-items-start">
                                <span class="icon icon-sm rounded-circle bg-primary-light">
                                    <i class="text-primary material-icons md-local_shipping"></i>
                                </span>
                                <div class="text">
                                    <h6 class="mb-1">Order info</h6>
                                    <p class="mb-1">
                                        <br> Pay method:<%=order.payment%> <br>
                                    </p>
                                    <a href="#">Download info</a>
                                </div>
                            </article>
                        </div> <!-- col// -->
                        <div class="col-md-4">
                            <article class="icontext align-items-start">
                                <span class="icon icon-sm rounded-circle bg-primary-light">
                                    <i class="text-primary material-icons md-place"></i>
                                </span>
                                <div class="text">
                                    <h6 class="mb-1">Deliver to</h6>
                                    <p class="mb-1">
                                        Address:<%=order.address.HouseName%>,<%=order.address.city%>,
                                                <%=order.address.state%>,<%=order.address.landMark%>,
                                                <span id="addressId"></span>    <%=order.address.pincode%>
                                    </p>
                                    <a href="#">View profile</a>
                                </div>
                            </article>
                        </div> <!-- col// -->
                    </div> <!-- row // -->
                    <div class="row">
                        <div class="col-lg-10">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th width="40%" class="text-center">Product</th>
                                            <th width="20%" class="text-center">Unit Price</th>
                                            <th width="20%" class="text-center">Quantity</th>
                                            <th width="20%" class="text-center">Total</th>
                                            <th width="20%" class="text-center px-5">Action</th>
                                            <th width="20%" class="text-center px-8">Status</th>

                                        </tr>
                                    </thead>
                                    <tbody>
                                        <%if(order.Items&&order.Items.length>0) {%>
                                            <% order.Items.forEach(item=>{%>
                                                <tr>
                                                    <td>
                                                        <a class="itemside" href="#">
                                                            <div class="left">
                                                                <img src="/Public/images/<%=item.Product.productImage[0]%> "
                                                                    width="40" height="40" class="img-xs" alt="Item">
                                                            </div>
                                                            <div class="info">
                                                                <%=item.Product.productName%>
                                                            </div>
                                                        </a>
                                                    </td>
                                                    <td class="text-center">
                                                        <%=item.price%>
                                                    </td>
                                                    <td class="text-center">
                                                        <%=item.quantity%>
                                                    </td>
                                                    <td class="text-center">
                                                        <%=item.price*item.quantity%>
                                                    <td>
                                                     <% if (order.status==='Delivered' ) { %>
                                                        <% if (item.status !== 'Return Processing') { %>
                                                            <button type="button" class="btn btn-primary"
                                                                onclick="confirmReturn('<%= order._id %>', '<%= item.Product._id %>', '<%= item.price * item.quantity %>')">Return
                                                            </button>
                                                            
                                                            <% } %>
                                                        <% } else if (item.status !== 'Delivered' && item.status !== 'Returned' && order.status !== 'Payment Failed') { %>
                                                            <% if (item.status !== 'Cancelled' && item.status !== 'Delivered') { %>
                                                                <button type="button" class="px-9 btn btn-danger"
                                                                    onclick="handleSelection('<%= order._id %>', '<%= item.Product._id %>', '<%= item.price * item.quantity %>')">Cancel Order</button>
                                                            <% } %>
                                                        <% } else if (order.status === 'Payment Failed') { %>
                                                            <button type="button" class="btn btn-info" id="payAgainButton">
                                                                Pay Again
                                                            </button>
                                                        <% } %>
                                                    
                                                    </td>

                                                    <td>
                                                        <% if (order.status === 'Delivered') { %>
                                                            <% if (item.status === 'Return Processing') { %>
                                                                <span class="badge rounded-pill alert-warning text-warning">
                                                                    <%= item.status %>
                                                                </span>
                                                            <% } else { %>
                                                                <span class="badge rounded-pill alert-success text-success">
                                                                    <%= order.status %>
                                                                </span>
                                                            <% } %>
                                                        <% } else if (order.status === 'Payment Failed') { %>
                                                            <span class="badge rounded-pill alert-danger text-danger">
                                                                <%= order.status %>
                                                            </span>
                                                        <% } else { %>
                                                            <% if (item.status === 'Confirmed') { %>
                                                                <span class="badge rounded-pill alert-primary text-primary">
                                                                    <%= item.status %>
                                                                </span>
                                                            <% } else if (item.status === 'Cancelled') { %>
                                                                <span class="badge rounded-pill alert-danger text-danger">
                                                                    <%= item.status %>
                                                                </span>
                                                            <% } else if (item.status === 'Delivered') { %>
                                                                <span class="badge rounded-pill alert-success text-success">
                                                                    <%= item.status %>
                                                                </span>
                                                            <% } else if (item.status === 'Return Processing') { %>
                                                                <span class="badge rounded-pill alert-warning text-warning">
                                                                    <%= item.status %>
                                                                </span>
                                                            <% } else if (item.status === 'Returned') { %>
                                                                <span class="badge rounded-pill alert-success text-success">
                                                                    <%= item.status %>
                                                                </span>
                                                            <% } else { %>
                                                                <span class="badge rounded-pill alert-warning text-warning">
                                                                    <%= item.status %>
                                                                </span>
                                                            <% } %>
                                                        <% } %>
                                                        
                                                    </td>

                                                </tr>
                                                <%})%>

                                                    <%}%>


                                                        <tr>
                                                            <td colspan="4">
                                    <article class="float-end">
        <% if (order.couponDetails && order.couponDetails.offerPrice > 0) { %>
            <dl class="dlist">
                <dt>Coupon Applied:</dt>
                <dd>
                    <b class="dark-text">
                        <%= order.couponDetails.offerPrice %>
                    </b>
                </dd>
            </dl>
            <dl class="dlist">
                <dt>Grand Total:</dt>
                <dd>
                    <b class="h5">
                        <%= order.totalPrice%>
                    </b>
                </dd>
            </dl>
        <% } else { %>
            <dl class="dlist">
                <dt>Grand Total:</dt>
                <dd>
                    <b class="h5">
                        <%= order.totalPrice %>
                    </b>
                </dd>
            </dl>
        <% } %>
    </article>
</td>
                                                        </tr>
                                    </tbody>
                                </table>
                            </div> <!-- table-responsive// -->
                        </div> <!-- col// -->
                        <div class="col-lg-1"></div>
                        <div class="col-lg-4">

                        </div>

                    </div>
                </div> <!-- col// -->
            </div>
            </div> <!-- card-body end// -->
            </div> <!-- card end// -->
        </section> <!-- content-main end// -->
        <footer class="main-footer font-xs">
            <div class="row pb-30 pt-15">

            </div>
            </div>
        </footer>
    </main>
    <script src="assets/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="assets/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="assets/js/vendors/select2.min.js"></script>
    <script src="assets/js/vendors/perfect-scrollbar.js"></script>
    <script src="assets/js/vendors/jquery.fullscreen.min.js"></script>
    <!-- Main Script -->
    <script src="assets/js/main.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script src="https://cdn.jsdelivr.net/npm/easyinvoice/dist/easyinvoice.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    

    <script>
        function handleSelection(orderId, productId) {
            console.log(productId, "id");
            Swal.fire({
                title: "Are you sure?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#14A44D",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/orderCancelled', {
                        method: "PATCH",
                        headers: { 'content-Type': 'application/json' },
                        body: JSON.stringify({ orderId, productId })
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Something went wrong!');
                            }
                            return response.json();
                        })
                        .then(data => {
                            Swal.fire({
                                title: "Cancelled!",
                                text: "Your order has been cancelled.",
                                icon: "success",
                                showConfirmButton: false
                            });
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        })
                        .catch(error => {
                            Swal.fire({
                                icon: "error",
                                title: "Oops...",
                                text: error.message || "Something went wrong!"
                            });
                        });
                }
            });



        }



        function confirmReturn(orderId, productId) {
            Swal.fire({
                title: 'Are you sure?',
                text: 'You are about to request a return for  this order.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, request return !'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/orderReturned', {
                        method: "PATCH",
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({  orderId, productId, status: 'Return Processing' })
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Something went wrong!');
                            }
                            return response.json();
                        })
                        .then(data => {
                            Swal.fire({
                                title: 'Return Requested!',
                                text: 'Your Return Request is now in Process.',
                                icon: 'success',
                                showConfirmButton: false
                            });
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        })
                        .catch(error => {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: error.message || 'Something went wrong!'
                            });
                        });
                }
            });
        }

    </script>




    <script>

        function invoiceDownload() {
    let orderDetails = JSON.parse(document.getElementById('orderData').value);
    console.log(orderDetails, "detaa");

    Swal.fire({
        title: "Are You Sure",
        text: "Do you want to download the invoice?",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "OK",
        cancelButtonText: "Cancel",
        cancelButtonColor: "red"
    }).then((result) => {
        if (result.isConfirmed) {
            let products = orderDetails.Items.map((item) => {
                return {
                    quantity: item.quantity,
                    description: item.Product.productName,
                    tax: 0,
                    price: item.Product.offerPrice || item.Product.price
                };
            });

           
            let subtotal = products.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let grandTotal = subtotal;
            let couponApplied = false;
            let couponAmount = 0;

            if (orderDetails.couponDetails && orderDetails.couponDetails.offerPrice > 0) {
                couponAmount = orderDetails.couponDetails.offerPrice;
                grandTotal -= couponAmount;
                couponApplied = true;
            }

            // Adding coupon details to the products array as additional entries
            // if (couponApplied) {
            //     products.push({
            //         quantity: 1,
            //         description: "Discount",
            //         tax: 0,
            //         price: -couponAmount
            //     });
            // }

            const data = {
                "apiKey": "free",
                "mode": "development",
                "documentTitle": "INVOICE TRANSFORM KID TOYS",
                "currency": "INR",
                "taxNotation": "GST",
                "marginTop": 20,
                "marginRight": 20,
                "marginLeft": 20,
                "marginBottom": 20,
                "logo": "https://public.easyinvoice.cloud/img/logo_en_original.png",
                "sender": {
                    "company": "TRANSFORM KID TOYS",
                    "address": "French Colony Pondicherry",
                    "zip": "1234 AB",
                    "city": "Pondicherry",
                    "country": "India"
                },
                "client": {
                    "company": orderDetails.userId.name,
                    "address": orderDetails.address.HouseName,
                    "zip": orderDetails.address.pincode,
                    "city": orderDetails.address.city,
                    "country": "India"
                },
                "invoiceNumber": orderDetails._id,
                "invoiceDate": new Date().toLocaleDateString(),
                "products": products,
                "bottomNotice": "Thank you for your business.",
                "information": {
                    "subTotal": subtotal,
                    "total": grandTotal
                },

            };

            easyinvoice.createInvoice(data, function(result) {
                easyinvoice.download('TRANSFORM KID TOYS_invoice.pdf', result.pdf);
            });
        }
    });
}
    </script>


    <script>
    document.getElementById('payAgainButton').addEventListener('click', () => {
        let orderId = document.getElementById('orderId').innerHTML
        fetch('/payAgain', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currency: 'INR',
                        receipt: 'receipt#1',
                        payment_capture: 1,
                        orderId
                    })
                })
                .then(response => response.json())
                .then(order => {
                    var options = {
                        "key": "rzp_test_uTqKInGV5tfzfy", 
                        "amount": order.amount *100,
                        "currency": order.currency,
                        "name": "Ecommerce Toy Store",
                        "description": "Test Transaction",
                        "image": "/assets/imgs/theme/logo.jpg",
                        "order_id": order.id,
                        handler: function (response) {
                            fetch('/payAgainVerifyPayment', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({orderId})
                            })
                            .then(verificationResponse => verificationResponse.json())
                            .then(verificationResult => {
                                if (verificationResult.success) {
                                    Swal.fire({
                                    position: "top-end",
                                    icon: "success",
                                    title: "Paid successfully",
                                    showConfirmButton: false,
                                    timer: 1500
                                    });
                                    setTimeout(() => {
                                        window.location.reload()
                                    }, 1502);
                                } else {
                                    Swal.fire({
                                    position: "top-end",
                                    icon: "error",
                                    title: "Something went wrong",
                                    showConfirmButton: false,
                                    timer: 1500
                                    });
                                    setTimeout(() => {
                                        window.location.reload()
                                    }, 1502);
                                }
                            })
                            .catch(error => console.error('Error:', error));
                        },
                        "prefill": {
                            "name": "Customer Name",
                            "email": "customer@example.com",
                            "contact": "9999999999"
                        },
                        "notes": {
                            "address": "Razorpay Corporate Office"
                        },
                        "theme": {
                            "color": "#3399cc"
                        }
                    };
                    var rzp1 = new Razorpay(options);
                    rzp1.on('payment.failed', function (response) {
                        alert('Payment has been failed');
                        alert(response.error);
                    });
                    rzp1.open();
                })
                .catch(error => console.error('Error:', error));
            });
    </script>
</body>
</html>